<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>My Bookings</h2>
    <span class="text-muted">{{ bookings.length }} total bookings</span>
  </div>

  <!-- Loading -->
  <div class="text-center py-5" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p class="mt-2 text-muted">Loading bookings...</p>
  </div>

  <!-- Bookings List -->
  <div class="row g-4" *ngIf="!isLoading">
    <div class="col-12" *ngFor="let booking of bookings">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3" *ngIf="getVehicle(booking.vehicleId) as vehicle">
              <img [src]="vehicle.images[0]" [alt]="vehicle.name" class="img-fluid rounded">
            </div>
            <div class="col-md-9">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h5 class="mb-1">{{ getVehicle(booking.vehicleId)?.name }}</h5>
                  <p class="text-muted mb-0">
                    <i class="bi bi-geo-alt me-1"></i>
                    {{ getVehicle(booking.vehicleId)?.location }}
                  </p>
                </div>
                <div class="text-end">
                  <span class="badge status-badge" [ngClass]="getStatusBadgeClass(booking.status)">
                    {{ booking.status }}
                  </span>
                  <div class="mt-1">
                    <small class="text-muted">Booking #{{ booking.id }}</small>
                  </div>
                </div>
              </div>

              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <div class="text-center p-2 bg-light rounded">
                    <i class="bi bi-calendar-event text-primary"></i>
                    <div class="small fw-bold">Start Date</div>
                    <div class="small">{{ booking.startDate | date:'short' }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center p-2 bg-light rounded">
                    <i class="bi bi-calendar-check text-success"></i>
                    <div class="small fw-bold">End Date</div>
                    <div class="small">{{ booking.endDate | date:'short' }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center p-2 bg-light rounded">
                    <i class="bi bi-currency-dollar text-warning"></i>
                    <div class="small fw-bold">Total Amount</div>
                    <div class="small">LKR {{ booking.totalAmount }}</div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center p-2 bg-light rounded">
                    <i class="bi bi-clock text-info"></i>
                    <div class="small fw-bold">Booked On</div>
                    <div class="small">{{ booking.bookingDate | date:'short' }}</div>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2">
                <button
                  class="btn btn-sm btn-outline-primary"
                  (click)="downloadAgreement(booking)"
                  *ngIf="booking.status !== 'CANCELLED'"
                >
                  <i class="bi bi-download me-1"></i>
                  Download Agreement
                </button>
                
                <button
                  class="btn btn-sm btn-success"
                  (click)="completeBooking(booking.id!)"
                  *ngIf="canCompleteBooking(booking)"
                  [disabled]="!canCompleteBooking(booking)"
                >
                  <i class="bi bi-check-circle me-1"></i>
                  Complete Booking
                </button>
                
                <button
                  class="btn btn-sm btn-danger"
                  (click)="cancelBooking(booking.id!)"
                  *ngIf="canCancelBooking(booking)"
                  [disabled]="!canCancelBooking(booking)"
                >
                  <i class="bi bi-x-circle me-1"></i>
                  Cancel Booking
                </button>
                
                <button
                  class="btn btn-sm btn-warning"
                  (click)="openReviewModal(booking)"
                  *ngIf="booking.status === 'COMPLETED' && !hasReview(booking.id!)"
                >
                  <i class="bi bi-star me-1"></i>
                  Write Review
                </button>
                
                <span class="badge bg-info" *ngIf="booking.status === 'COMPLETED' && hasReview(booking.id!)">
                  <i class="bi bi-star-fill me-1"></i>Reviewed
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Bookings -->
  <div class="text-center py-5" *ngIf="!isLoading && bookings.length === 0">
    <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
    <h4 class="mt-3">No bookings yet</h4>
    <p class="text-muted mb-4">Start by browsing available vehicles</p>
    <a routerLink="/vehicles" class="btn btn-primary">
      <i class="bi bi-search me-2"></i>Browse Vehicles
    </a>
  </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" *ngIf="selectedBooking">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-star me-2"></i>Write Review for {{ getVehicle(selectedBooking.vehicleId)?.name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <div class="d-flex gap-2 mb-2">
              <button
                type="button"
                class="btn btn-outline-warning"
                *ngFor="let star of [1,2,3,4,5]; let i = index"
                [class.btn-warning]="i < reviewData.rating"
                (click)="setRating(i + 1)"
              >
                <i class="bi bi-star-fill"></i>
              </button>
            </div>
            <small class="text-muted">{{ getRatingText(reviewData.rating) }}</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Comment</label>
            <textarea
              class="form-control"
              rows="4"
              [(ngModel)]="reviewData.comment"
              name="comment"
              required
              placeholder="Share your experience with this vehicle..."
            ></textarea>
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" [disabled]="!reviewForm.form.valid || reviewData.rating === 0 || isSubmittingReview">
              <span *ngIf="isSubmittingReview" class="loading-spinner me-2"></span>
              {{ isSubmittingReview ? 'Submitting...' : 'Submit Review' }}
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>